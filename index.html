<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Tafeloverzicht</title>

<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280;
    --nieuw:#ef4444; --drank:#f59e0b; --run:#10b981; --koffie:#7c3aed; --rekening:#0ea5e9;
    --border:#e5e7eb; --label:#eef2f7;

    /* dynamisch in JS */
    --gap:10px;
    --tile:86px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:flex; flex-direction:column; min-height:100vh;
  }

  header{
    background:var(--card); border-bottom:1px solid var(--border);
    padding:8px 12px;
    display:flex; align-items:center; gap:10px;
    flex:0 0 auto;
  }
  .title{
    font-weight:900;
    font-size:clamp(14px, 2.4vw, 19px);
    flex:1;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  main{
    flex:1 1 auto;
    min-height:0;
    display:flex;
    flex-direction:column;
    gap:8px;
    padding:8px 12px 12px;
  }

  .toolbar{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    flex:0 0 auto;
  }
  .btn{
    appearance:none;
    background:#fff;
    border:1px solid var(--border);
    color:#111827;
    padding:7px 11px;
    border-radius:10px;
    font-weight:900;
    cursor:pointer;
    font-size:clamp(12px, 2.2vw, 14px);
  }
  .help-btn{ border:2px solid var(--nieuw); color:var(--nieuw); letter-spacing:1px; }
  .text-btn{ border:2px solid #111827; color:#111827; letter-spacing:1px; }

  .groups{
    flex:1 1 auto;
    min-height:0;
    display:flex;
    flex-direction:column;
    gap:10px;            /* used by layoutToFit (betweenGroups) */
    overflow:hidden;
  }
  .group{
    min-height:0;
    display:flex;
    flex-direction:column;
    gap:6px;
    /* flex is set dynamically in JS based on row counts (prevents big empty gap) */
  }

  /* compacte labels */
  .group-label{
    flex:0 0 auto;
    background:var(--label);
    border:1px solid var(--border);
    border-radius:8px;
    padding:4px 8px;
    font-weight:1000;
    letter-spacing:.2px;
    font-size:clamp(12px, 2.0vw, 14px);
    line-height:1.1;
  }

  .group-grid{
    --cols: 6;
    display:grid;
    grid-template-columns:repeat(var(--cols), var(--tile));
    grid-auto-rows:var(--tile);
    gap:var(--gap);
    justify-content:center;
    align-content:start;
    flex:1 1 auto;
    min-height:0;
    overflow:hidden;
  }

  .table{
    width:var(--tile); height:var(--tile);
    border-radius:14px;
    background:var(--card);
    border:1px solid var(--border);
    display:grid;
    grid-template-rows:auto 1fr auto;
    align-items:center;
    justify-items:center;
    padding:7px;
    gap:4px;
    position:relative;
    user-select:none;
    cursor:pointer;
  }
  .num{
    font-weight:1000;
    font-size:calc(var(--tile) * 0.24);
    line-height:1;
  }
  .num.num-flagged{ color: var(--nieuw); }

  .note{
    font-weight:700;
    font-size:calc(var(--tile) * 0.14);
    text-align:center;
    line-height:1.12;
    max-width:100%;
    max-height:2.3em;
    overflow:hidden;
    text-overflow:ellipsis;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
  }

  .timer{
    position:absolute;
    bottom:5px;
    left:50%;
    transform:translateX(-50%);
    font-weight:800;
    font-size:calc(var(--tile) * 0.14);
    color:#475569;
    pointer-events:none;
  }

  .table[data-status]{ color:#fff; border-color:transparent; }
  .table[data-status] .num{ color:#fff !important; }
  .table[data-status] .note{ color:#fff; }
  .table[data-status] .timer{ color:#fff; }

  .table.status-nieuw{ background:var(--nieuw); }
  .table.status-drank{ background:var(--drank); }
  .table.status-run{ background:var(--run); }
  .table.status-koffie{ background:var(--koffie); }
  .table.status-rekening{ background:var(--rekening); }

  /* overlays */
  .overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.6);
    display:none; align-items:center; justify-content:center;
    padding:16px;
    z-index:2147483647;
  }
  .overlay.open{ display:flex; }

  .modal{
    width:100%;
    max-width:520px;
    background:#fff;
    border:1px solid var(--border);
    border-radius:16px;
    box-shadow:0 12px 35px rgba(0,0,0,.28);
    overflow:hidden;
  }
  .modal-header{
    padding:12px 14px;
    font-weight:1000;
    border-bottom:1px solid var(--border);
    background:#fff;
  }
  .modal-grid{
    padding:12px 14px;
    display:grid;
    gap:10px;
    grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
    background:#fff;
  }
  .choice{
    border:1px solid var(--border);
    background:#fff;
    border-radius:12px;
    padding:12px;
    font-weight:900;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
  }
  .choice.reset{
    border-color:#9ca3af;
    color:#374151;
  }
  .swatch{ width:16px; height:16px; border-radius:5px; }
  .swatch.nieuw{background:var(--nieuw)}
  .swatch.drank{background:var(--drank)}
  .swatch.run{background:var(--run)}
  .swatch.koffie{background:var(--koffie)}
  .swatch.rekening{background:var(--rekening)}

  .modal-footer{
    padding:10px 12px;
    border-top:1px solid var(--border);
    display:flex;
    gap:10px;
    justify-content:space-between;
    align-items:center;
    background:#fff;
  }
  .link{
    border:1px solid var(--border);
    background:#fff;
    border-radius:12px;
    padding:9px 11px;
    font-weight:900;
    cursor:pointer;
  }
  .link.primary{
    background:#2563eb;
    border-color:#2563eb;
    color:#fff;
  }
  .danger{ border-color:#ef4444; color:#ef4444; }

  .note-editor{
    display:none;
    padding:12px 14px;
    border-top:1px solid var(--border);
    background:#fff;
  }
  .note-editor.open{ display:block; }
  .note-editor textarea{
    width:100%;
    min-height:90px;
    padding:12px;
    border:1px solid var(--border);
    border-radius:12px;
    font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    resize:vertical;
  }
  .note-actions{
    display:flex;
    gap:8px;
    justify-content:flex-end;
    margin-top:10px;
  }

  .menu-header.help{ color:var(--nieuw); }
  .menu-header.text{ color:#111827; }

  .input-wrap{ padding:12px 14px; display:grid; gap:10px; }
  .input-wrap input{
    width:100%;
    padding:12px 12px;
    border:1px solid var(--border);
    border-radius:12px;
    font:16px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .input-hint{ font-size:12px; color:var(--muted); }

  /* fullscreen boodschap: alleen tekst */
  .alert-screen{
    position:fixed; inset:0;
    background:#fff; color:#000;
    display:none;
    align-items:center; justify-content:center;
    z-index:2147483647;
    padding:24px;
    text-align:center;
  }
  .alert-screen.show{ display:flex; }
  .alert-only{
    font-size:clamp(36px, 9vw, 96px);
    font-weight:1100;
    line-height:1.08;
    white-space:pre-wrap;
    word-break:break-word;
    max-width:min(1000px, 94vw);
  }
</style>
</head>

<body>
<header>
  <div class="title">Tafeloverzicht</div>
</header>

<main>
  <div class="toolbar">
    <button class="btn" id="resetAll">Reset alles</button>
    <button class="btn help-btn" id="helpBtn">HELP</button>
    <button class="btn text-btn" id="textBtn">TEXT</button>
  </div>

  <div class="groups" id="groups"></div>
</main>

<!-- Status / Notitie modal -->
<div id="overlay" class="overlay" aria-modal="true" role="dialog">
  <div class="modal">
    <div class="modal-header">Tafel <span id="modalTableNum"></span></div>

    <div class="modal-grid" id="statusChoices">
      <button class="choice" data-choice="nieuw"><span class="swatch nieuw"></span>Nieuw</button>
      <button class="choice" data-choice="drank"><span class="swatch drank"></span>Drank</button>
      <button class="choice" data-choice="run"><span class="swatch run"></span>Run</button>
      <button class="choice" data-choice="koffie"><span class="swatch koffie"></span>Koffie</button>
      <button class="choice" data-choice="rekening"><span class="swatch rekening"></span>Rekening</button>
      <button class="choice reset" data-choice="resetnum">Reset (rode cijfers)</button>
    </div>

    <div class="note-editor" id="noteEditor">
      <textarea id="noteInput" placeholder="Notitie voor deze tafel..."></textarea>
      <div class="note-actions">
        <button class="link danger" id="deleteNote">Verwijder notitie</button>
        <button class="link" id="cancelNote">Annuleren</button>
        <button class="link primary" id="saveNote">Opslaan</button>
      </div>
    </div>

    <div class="modal-footer">
      <button class="link" id="cancelModal">Sluiten</button>
      <button class="link primary" id="openNote">Notitie toevoegen/bewerken</button>
    </div>
  </div>
</div>

<!-- HELP menu -->
<div id="helpOverlay" class="overlay" aria-modal="true" role="dialog">
  <div class="modal">
    <div class="modal-header menu-header help">KIES HULPLOCATIE</div>
    <div class="modal-grid">
      <button class="choice" data-broadcast="Bar Beneden">Bar Beneden</button>
      <button class="choice" data-broadcast="Bar Boven">Bar Boven</button>
      <button class="choice" data-broadcast="Run">Run</button>
      <button class="choice reset" id="helpCancel">Annuleren</button>
    </div>
  </div>
</div>

<!-- TEXT menu -->
<div id="textOverlay" class="overlay" aria-modal="true" role="dialog">
  <div class="modal">
    <div class="modal-header menu-header text">KIES BERICHT</div>
    <div class="modal-grid">
      <button class="choice" data-text="Boven uithalen">Boven uithalen</button>
      <button class="choice" data-text="IJs brengen">IJs brengen</button>
      <button class="choice" id="openCustomText">Eigen invoer</button>
      <button class="choice reset" id="textCancel">Annuleren</button>
    </div>
  </div>
</div>

<!-- Eigen invoer -->
<div id="customTextOverlay" class="overlay" aria-modal="true" role="dialog">
  <div class="modal">
    <div class="modal-header">Eigen bericht</div>
    <div class="input-wrap">
      <input id="customTextInput" type="text" maxlength="80" placeholder="Typ een bericht (max 80 tekens)..." />
      <div class="input-hint">Wordt direct op alle apparaten getoond. Verdwijnt bij 1 tik of na 6 sec.</div>
    </div>
    <div class="modal-footer">
      <button class="link" id="customTextClose">Sluiten</button>
      <button class="link primary" id="customTextSend">Versturen</button>
    </div>
  </div>
</div>

<!-- Fullscreen broadcast -->
<div id="alertScreen" class="alert-screen" aria-live="assertive" aria-atomic="true">
  <div id="alertText" class="alert-only"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== Supabase ===== */
const SUPABASE_URL  = "https://xiwdbvxnjcrdwjhmpjnf.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhpd2RidnhuamNyZHdqaG1wam5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NjE1NzAsImV4cCI6MjA3MDIzNzU3MH0.d14QNY5Pof9j3zmlbs-5gBTs25s6xo_XYhyVbWE2P1k";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ===== Config ===== */
const RANGES_BENEDEN = [[1,13]];
const RANGES_BOVEN   = [[20,58]];
const GROUPS = [
  { label:'Beneden', zone:'bt', ranges:RANGES_BENEDEN },
  { label:'Boven',   zone:'boven', ranges:RANGES_BOVEN }
];

const STATUS_CLASSES = {
  nieuw:"status-nieuw",
  drank:"status-drank",
  run:"status-run",
  koffie:"status-koffie",
  rekening:"status-rekening"
};

function expandRanges(r){ const out=[]; for(const [a,b] of r){ for(let i=a;i<=b;i++) out.push(i);} return out; }
function keyOf(zone, n){ return `${zone}-${n}`; }

/* ===== Elements ===== */
const groupsEl = document.getElementById('groups');

const overlay = document.getElementById('overlay');
const modalTableNum = document.getElementById('modalTableNum');
const statusChoices = document.getElementById('statusChoices');
const noteEditor = document.getElementById('noteEditor');
const noteInput = document.getElementById('noteInput');
const openNoteBtn = document.getElementById('openNote');
const cancelModalBtn = document.getElementById('cancelModal');
const saveNoteBtn = document.getElementById('saveNote');
const deleteNoteBtn = document.getElementById('deleteNote');
const cancelNoteBtn = document.getElementById('cancelNote');

const resetAllBtn = document.getElementById('resetAll');

const helpBtnEl = document.getElementById('helpBtn');
const helpOverlayEl = document.getElementById('helpOverlay');
const helpCancelEl = document.getElementById('helpCancel');

const textBtnEl = document.getElementById('textBtn');
const textOverlayEl = document.getElementById('textOverlay');
const textCancelEl = document.getElementById('textCancel');
const openCustomTextEl = document.getElementById('openCustomText');

const customTextOverlayEl = document.getElementById('customTextOverlay');
const customTextInputEl = document.getElementById('customTextInput');
const customTextSendEl = document.getElementById('customTextSend');
const customTextCloseEl = document.getElementById('customTextClose');

const alertScreenEl = document.getElementById('alertScreen');
const alertTextEl = document.getElementById('alertText');

/* ===== State ===== */
let rows = new Map();
let pendingCell = null;
let timerInterval = null;
let tablesChannel = null;
let eventsChannel = null;

/* ===== Data ===== */
async function fetchAll(){
  const { data, error } = await sb.from('tables_status').select('*');
  if(error){ console.error('fetchAll error', error); return; }
  rows = new Map((data||[]).map(r=>[keyOf(r.zone,r.table_num), r]));
}

async function upsertTable(zone, num, patch){
  const prev = rows.get(keyOf(zone,num)) || { zone, table_num:num };
  const payload = {
    status:null, status_started:null, note:null, num_marked:false,
    ...prev,
    ...patch,
    updated_at: new Date().toISOString()
  };
  const { data, error } = await sb.from('tables_status').upsert(payload).select().single();
  if(error){ console.error('upsert error', error); return prev; }
  rows.set(keyOf(zone,num), data);
  return data;
}

/* ===== UI helpers ===== */
function applyStatus(cell, status){
  cell.classList.remove(...Object.values(STATUS_CLASSES));
  if(status){
    cell.classList.add(STATUS_CLASSES[status]);
    cell.setAttribute('data-status', status);
  } else {
    cell.removeAttribute('data-status');
  }
}
function setNote(cell, txt){ cell.querySelector('.note').textContent = txt || ''; }
function setTimer(cell, txt){ cell.querySelector('.timer').textContent = txt || ''; }
function setNumFlag(cell, flagged){ cell.querySelector('.num').classList.toggle('num-flagged', !!flagged); }
function fmtElapsed(ms){
  const total = Math.max(0, Math.floor(ms/1000));
  const s = total % 60;
  const m = Math.floor(total/60) % 60;
  const h = Math.floor(total/3600);
  const pad = n => n<10 ? '0'+n : ''+n;
  return h ? `${h}:${pad(m)}:${pad(s)}` : `${m}:${pad(s)}`;
}

/* ✅ Dynamische gap */
function applyResponsiveGap(){
  const minSide = Math.min(window.innerWidth, window.innerHeight);
  let gap = Math.round(minSide / 90);
  gap = Math.max(5, Math.min(12, gap));
  document.documentElement.style.setProperty('--gap', gap + 'px');
}

/* ✅ Tiles maximaal + hoogte verdelen op rij-aantal (geen groot leeg gat) */
function layoutToFit(){
  const gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 8;

  const avail = groupsEl.getBoundingClientRect();
  const availW = Math.floor(avail.width);
  const availH = Math.floor(avail.height);

  const labels = groupsEl.querySelectorAll('.group-label');
  let labelH = 0;
  labels.forEach(l=> labelH += Math.ceil(l.getBoundingClientRect().height));

  const betweenGroups = 10; // match .groups gap
  const N_b = expandRanges(RANGES_BENEDEN).length; // 13
  const N_t = expandRanges(RANGES_BOVEN).length;   // 39

  let best = null;

  for(let cb=1; cb<=N_b; cb++){
    const rb = Math.ceil(N_b / cb);
    const tileW_b = Math.floor((availW - (cb-1)*gap) / cb);

    for(let ct=1; ct<=N_t; ct++){
      const rt = Math.ceil(N_t / ct);
      const tileW_t = Math.floor((availW - (ct-1)*gap) / ct);

      const totalRows = rb + rt;
      const gapsV = (rb-1 + rt-1) * gap + betweenGroups;

      const tileH_limit = Math.floor((availH - labelH - gapsV) / totalRows);
      const tileW_limit = Math.min(tileW_b, tileW_t);
      const tile = Math.max(0, Math.min(tileH_limit, tileW_limit));

      if(!best || tile > best.tile){
        best = { cb, ct, rb, rt, tile };
      }
    }
  }

  if(!best || best.tile < 26){
    best = {
      cb: 6,
      ct: 10,
      rb: Math.ceil(N_b / 6),
      rt: Math.ceil(N_t / 10),
      tile: 26
    };
  }

  document.documentElement.style.setProperty('--tile', best.tile + 'px');

  document.querySelectorAll('.group-grid').forEach(grid=>{
    const zone = grid.dataset.zone;
    grid.style.setProperty('--cols', (zone === 'bt') ? best.cb : best.ct);
  });

  // ✅ flex verdeling: hoogte in verhouding tot rijen
  const benedenGroup = document.querySelector('.group[data-zone="bt"]');
  const bovenGroup   = document.querySelector('.group[data-zone="boven"]');
  if(benedenGroup) benedenGroup.style.flex = `${best.rb} 1 0%`;
  if(bovenGroup)   bovenGroup.style.flex  = `${best.rt} 1 0%`;
}

/* ===== Render ===== */
function render(){
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  groupsEl.innerHTML = '';

  for(const group of GROUPS){
    const nums = expandRanges(group.ranges);

    const wrap = document.createElement('section');
    wrap.className = 'group';
    wrap.dataset.zone = group.zone; // ✅ nodig voor flex verdeling

    const label = document.createElement('div');
    label.className = 'group-label';
    label.textContent = group.label;

    const grid = document.createElement('div');
    grid.className = 'group-grid';
    grid.dataset.zone = group.zone;

    wrap.appendChild(label);
    wrap.appendChild(grid);
    groupsEl.appendChild(wrap);

    for(const n of nums){
      const r = rows.get(keyOf(group.zone,n)) || {};

      const cell = document.createElement('button');
      cell.type = 'button';
      cell.className = 'table';
      cell.dataset.zone = group.zone;
      cell.dataset.num = n;

      cell.innerHTML = `
        <div class="num">${n}</div>
        <div class="note"></div>
        <div class="timer"></div>
      `;

      applyStatus(cell, r.status || null);
      setNote(cell, r.note || '');
      setNumFlag(cell, !!r.num_marked);

      cell.addEventListener('click', async ()=>{
        const cur = rows.get(keyOf(group.zone,n)) || {};
        const hasStatus = !!cur.status || cell.hasAttribute('data-status');

        // 1 klik op gekleurde tafel = leeg (num_marked blijft)
        if(hasStatus){
          const keepFlag = !!cur.num_marked;
          await upsertTable(group.zone, n, { status:null, status_started:null, num_marked: keepFlag });
          applyStatus(cell, null);
          setTimer(cell, '');
          setNumFlag(cell, keepFlag);
          return;
        }

        pendingCell = cell;
        modalTableNum.textContent = n;
        noteInput.value = cur.note || '';
        showChoicesPane();
        overlay.classList.add('open');
      });

      grid.appendChild(cell);
    }
  }

  function tick(){
    const now = Date.now();
    document.querySelectorAll('.table').forEach(cell=>{
      const zone = cell.dataset.zone;
      const num = Number(cell.dataset.num);
      const r = rows.get(keyOf(zone,num));
      if(r && r.status && r.status_started){
        setTimer(cell, fmtElapsed(now - Date.parse(r.status_started)));
      } else {
        setTimer(cell, '');
      }
    });
  }
  tick();
  timerInterval = setInterval(tick, 1000);

  applyResponsiveGap();
  layoutToFit();
}

/* ===== Modal panes ===== */
function showChoicesPane(){ statusChoices.style.display = 'grid'; noteEditor.classList.remove('open'); }
function showNotePane(){ statusChoices.style.display = 'none'; noteEditor.classList.add('open'); }

/* ===== Status choices ===== */
overlay.querySelectorAll('.choice[data-choice]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    if(!pendingCell) return;
    const choice = btn.dataset.choice;
    const zone = pendingCell.dataset.zone;
    const num = Number(pendingCell.dataset.num);

    if(choice === 'resetnum'){
      await upsertTable(zone, num, { num_marked:false });
      setNumFlag(pendingCell, false);
      overlay.classList.remove('open'); pendingCell=null; showChoicesPane();
      return;
    }

    const patch = { status: choice, status_started: new Date().toISOString() };
    if(choice === 'nieuw') patch.num_marked = true;

    await upsertTable(zone, num, patch);

    applyStatus(pendingCell, choice);
    if(choice === 'nieuw') setNumFlag(pendingCell, true);

    overlay.classList.remove('open');
    pendingCell = null;
  });
});

/* Note */
openNoteBtn.addEventListener('click', ()=>{ if(pendingCell) showNotePane(); });
saveNoteBtn.addEventListener('click', async ()=>{
  if(!pendingCell) return;
  const zone = pendingCell.dataset.zone;
  const num = Number(pendingCell.dataset.num);
  const txt = noteInput.value.trim();
  await upsertTable(zone, num, { note: txt || null });
  setNote(pendingCell, txt);
  overlay.classList.remove('open'); pendingCell=null; showChoicesPane();
});
deleteNoteBtn.addEventListener('click', async ()=>{
  if(!pendingCell) return;
  const zone = pendingCell.dataset.zone;
  const num = Number(pendingCell.dataset.num);
  await upsertTable(zone, num, { note: null });
  setNote(pendingCell, '');
  overlay.classList.remove('open'); pendingCell=null; showChoicesPane();
});
cancelNoteBtn.addEventListener('click', showChoicesPane);

cancelModalBtn.addEventListener('click', ()=>{ overlay.classList.remove('open'); pendingCell=null; showChoicesPane(); });
overlay.addEventListener('click', (e)=>{ if(e.target===overlay){ overlay.classList.remove('open'); pendingCell=null; showChoicesPane(); }});

/* Reset */
async function fullResetAll(){
  for(const g of GROUPS){
    for(const n of expandRanges(g.ranges)){
      const r = rows.get(keyOf(g.zone,n));
      if(!r) continue;
      await upsertTable(g.zone, n, { status:null, status_started:null, num_marked:false });
    }
  }
  render();
}
resetAllBtn.addEventListener('click', fullResetAll);

/* Auto reset 02:00 */
async function autoDailyResetCheck(){
  const now = new Date();
  const hh = now.getHours(), mm = now.getMinutes();
  const todayKey = now.toISOString().slice(0,10);
  const last = localStorage.getItem('last_auto_reset');
  if(hh === 2 && mm < 5 && last !== todayKey){
    await fullResetAll();
    localStorage.setItem('last_auto_reset', todayKey);
  }
}
setInterval(autoDailyResetCheck, 60_000);

/* Broadcast */
function showBroadcast(message){
  const msg = (message || '').toString().trim();
  if(!msg) return;

  alertTextEl.textContent = msg;
  alertScreenEl.classList.add('show');

  const close = ()=>{
    alertScreenEl.classList.remove('show');
    alertScreenEl.removeEventListener('click', close);
  };
  alertScreenEl.addEventListener('click', close);
  setTimeout(close, 6000);
}
async function sendBroadcast(message){
  const msg = (message || '').toString().trim();
  if(!msg) return;
  const { error } = await sb.from('help_events').insert({ kind: msg });
  if(error) console.error('broadcast insert error', error);
}

/* HELP */
helpBtnEl.addEventListener('click', ()=> helpOverlayEl.classList.add('open'));
helpOverlayEl.addEventListener('click', (e)=>{ if(e.target===helpOverlayEl) helpOverlayEl.classList.remove('open'); });
helpCancelEl.addEventListener('click', ()=> helpOverlayEl.classList.remove('open'));
helpOverlayEl.querySelectorAll('[data-broadcast]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const msg = btn.dataset.broadcast;
    helpOverlayEl.classList.remove('open');
    await sendBroadcast(msg);
    showBroadcast(msg);
  });
});

/* TEXT */
textBtnEl.addEventListener('click', ()=> textOverlayEl.classList.add('open'));
textOverlayEl.addEventListener('click', (e)=>{ if(e.target===textOverlayEl) textOverlayEl.classList.remove('open'); });
textCancelEl.addEventListener('click', ()=> textOverlayEl.classList.remove('open'));

textOverlayEl.querySelectorAll('[data-text]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const msg = btn.dataset.text;
    textOverlayEl.classList.remove('open');
    await sendBroadcast(msg);
    showBroadcast(msg);
  });
});
openCustomTextEl.addEventListener('click', ()=>{
  textOverlayEl.classList.remove('open');
  customTextInputEl.value = '';
  customTextOverlayEl.classList.add('open');
  setTimeout(()=>customTextInputEl.focus(), 50);
});
customTextCloseEl.addEventListener('click', ()=> customTextOverlayEl.classList.remove('open'));
customTextOverlayEl.addEventListener('click', (e)=>{ if(e.target===customTextOverlayEl) customTextOverlayEl.classList.remove('open'); });
async function sendCustom(){
  const msg = customTextInputEl.value.trim();
  if(!msg) return;
  customTextOverlayEl.classList.remove('open');
  await sendBroadcast(msg);
  showBroadcast(msg);
}
customTextSendEl.addEventListener('click', sendCustom);
customTextInputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendCustom(); }});

/* Realtime */
function subscribeRealtimeTables(){
  if(tablesChannel) sb.removeChannel(tablesChannel);
  tablesChannel = sb.channel('tables_status:all')
    .on('postgres_changes', { event:'*', schema:'public', table:'tables_status' }, payload=>{
      const row = payload.new || payload.old;
      if(!row) return;
      rows.set(keyOf(row.zone,row.table_num), payload.new || row);

      const cell = document.querySelector(`.table[data-zone="${row.zone}"][data-num="${row.table_num}"]`);
      if(cell){
        const r = rows.get(keyOf(row.zone,row.table_num));
        applyStatus(cell, r.status || null);
        setNote(cell, r.note || '');
        setNumFlag(cell, !!r.num_marked);
        if(!(r && r.status && r.status_started)) setTimer(cell, '');
      }
    })
    .subscribe();
}
function subscribeBroadcasts(){
  if(eventsChannel) sb.removeChannel(eventsChannel);
  eventsChannel = sb.channel('help_events:all')
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'help_events' }, payload=>{
      const row = payload?.new;
      if(row?.kind) showBroadcast(row.kind);
    })
    .subscribe();
}

/* Resize */
let raf=null;
function scheduleLayout(){
  if(raf) cancelAnimationFrame(raf);
  raf = requestAnimationFrame(()=>{
    raf=null;
    applyResponsiveGap();
    layoutToFit();
  });
}
window.addEventListener('resize', scheduleLayout);
window.addEventListener('orientationchange', ()=>setTimeout(()=>{ applyResponsiveGap(); layoutToFit(); }, 60));

/* Init */
(async function init(){
  await fetchAll();
  render();
  subscribeRealtimeTables();
  subscribeBroadcasts();
  autoDailyResetCheck();
  applyResponsiveGap();
  layoutToFit();
})();
</script>
</body>
</html>
